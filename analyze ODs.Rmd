---
title: "analyze ODs"
author: "Catherine DiGennaro"
date: "5/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

import OD data
```{r}
all_ODs <- read.csv("NCHS_all_ODs.csv") 
```

concatenate ICD columns
```{r}
all_ODs <- all_ODs %>% 
  unite(all_codes, record_1:record_20, sep = "|", remove=TRUE)
```

assign specific drug category codes 
```{r}
opioids <- "T400|T401|T402|T403|T404|T406"
opioids_without_fentanyl <- "T400|T401|T402|T403|T406"
fentanyl <- "T404"
cocaine <- "T405"
psychostimulants <- "T436"
alcohol <- "E244|F10|G312|G621|G721|I426|K292|K70|K852|K860|R780|X45|X65|Y15"
```

classify each overdose by type of drug present
```{r}
ODs_classified <- all_ODs %>% 
  mutate(opioids = case_when(grepl(opioids, all_codes) ~ 1,
                             TRUE ~ 0),
         opioids_without_fentanyl = case_when(grepl(opioids_without_fentanyl, all_codes) ~ 1,
                             TRUE ~ 0),
         fentanyl = case_when(grepl(fentanyl, all_codes) ~ 1,
                             TRUE ~ 0),
         cocaine = case_when(grepl(cocaine, all_codes) ~ 1,
                             TRUE ~ 0),
         psychostimulants = case_when(grepl(psychostimulants, all_codes) ~ 1,
                                      TRUE ~ 0),
         alcohol = case_when(grepl(alcohol, all_codes) ~ 1,
                             TRUE ~ 0))
```

classify each drug overdose by whether alcohol was present
```{r}
ODs_alcohol <- ODs_classified %>% 
  mutate(opioids_w_alc = case_when(opioids==1 &
                                     alcohol==1 ~ 1,
                                   TRUE ~ 0),
         opioids_wo_alc = case_when(opioids==1 &
                                     alcohol==0 ~ 1,
                                   TRUE ~ 0),
         opioids_without_fentanyl_w_alc = case_when(opioids_without_fentanyl==1 &
                                     alcohol==1 ~ 1,
                                   TRUE ~ 0),
         opioids_without_fentanyl_wo_alc = case_when(opioids_without_fentanyl==1 &
                                     alcohol==0 ~ 1,
                                   TRUE ~ 0),
         fentanyl_w_alc = case_when(fentanyl==1 &
                                     alcohol==1 ~ 1,
                                   TRUE ~ 0),
         fentanyl_wo_alc = case_when(fentanyl==1 &
                                     alcohol==0 ~ 1,
                                   TRUE ~ 0),
         cocaine_w_alc = case_when(cocaine==1 &
                                     alcohol==1 ~ 1,
                                   TRUE ~ 0),
         cocaine_wo_alc = case_when(cocaine==1 &
                                     alcohol==0 ~ 1,
                                   TRUE ~ 0),
         psychostimulants_w_alc = case_when(psychostimulants==1 &
                                     alcohol==1 ~ 1,
                                   TRUE ~ 0),
         psychostimulants_wo_alc = case_when(psychostimulants==1 &
                                     alcohol==0 ~ 1,
                                   TRUE ~ 0))
```


assign mutually exclusive labels to drug overdoses
nb: opioids_only does encompass opioids_without_fentanyl and fentanyl; truly mutually exclusive labelling does not include opioids_only, but it is of interest in this project.
```{r}
ODs_mut_excl <- ODs_alcohol %>% 
  mutate(opioids_only = case_when(opioids==1 & 
                                    cocaine==0 & 
                                    psychostimulants==0 ~ 1,
                                  TRUE ~ 0),
         opioids_without_fentanyl_only = case_when(opioids_without_fentanyl==1 &
                                                     fentanyl==0 &
                                                     cocaine==0 &
                                                     psychostimulants==0 ~ 1,
                                                   TRUE ~ 0),
         fentanyl_only = case_when(fentanyl==1 & 
                                     cocaine==0 &
                                     psychostimulants==0 & 
                                     opioids_without_fentanyl==0 ~ 1, 
                                   TRUE ~ 0),
         cocaine_only = case_when(cocaine==1 &
                                    opioids==0 &
                                    psychostimulants==0 ~ 1,
                                  TRUE ~ 0),
         psychostimulants_only = case_when(psychostimulants==1 &
                                             cocaine==0 &
                                             opioids==0 ~ 1,
                                           TRUE ~ 0),
         opioids_only_w_alc = case_when(opioids==1 & 
                                          cocaine==0 & 
                                          psychostimulants==0 &
                                          alcohol==1 ~ 1,
                                  TRUE ~ 0),
         opioids_without_fentanyl_only_w_alc = case_when(opioids_without_fentanyl==1 &
                                                     fentanyl==0 &
                                                     cocaine==0 &
                                                     psychostimulants==0 &
                                                     alcohol==1 ~ 1,
                                                   TRUE ~ 0),
         fentanyl_only_w_alc = case_when(fentanyl==1 & 
                                     cocaine==0 &
                                     psychostimulants==0 & 
                                     opioids_without_fentanyl==0 &
                                     alcohol==1 ~ 1, 
                                   TRUE ~ 0),
         cocaine_only_w_alc = case_when(cocaine==1 &
                                    opioids==0 &
                                    psychostimulants==0 &
                                      alcohol==1 ~ 1,
                                  TRUE ~ 0),
         psychostimulants_only_w_alc = case_when(psychostimulants==1 &
                                             cocaine==0 &
                                             opioids==0 &
                                               alcohol==1 ~ 1,
                                           TRUE ~ 0),
         opioids_only_wo_alc = case_when(opioids==1 & 
                                          cocaine==0 & 
                                          psychostimulants==0 &
                                          alcohol==0 ~ 1,
                                  TRUE ~ 0),
         opioids_without_fentanyl_only_wo_alc = case_when(opioids_without_fentanyl==1 &
                                                     fentanyl==0 &
                                                     cocaine==0 &
                                                     psychostimulants==0 &
                                                     alcohol==0 ~ 1,
                                                   TRUE ~ 0),
         fentanyl_only_wo_alc = case_when(fentanyl==1 & 
                                     cocaine==0 &
                                     psychostimulants==0 & 
                                     opioids_without_fentanyl==0 &
                                     alcohol==0 ~ 1, 
                                   TRUE ~ 0),
         cocaine_only_wo_alc = case_when(cocaine==1 &
                                    opioids==0 &
                                    psychostimulants==0 &
                                      alcohol==0 ~ 1,
                                  TRUE ~ 0),
         psychostimulants_only_wo_alc = case_when(psychostimulants==1 &
                                             cocaine==0 &
                                             opioids==0 &
                                               alcohol==0 ~ 1,
                                           TRUE ~ 0)
         )
```

assign polysubstance drug overdoses by combos of drugs present
```{r}
ODs_polysub <- ODs_mut_excl %>%
  mutate(opioids_and_cocaine_only = case_when(cocaine==1 &
                                           opioids==1 &
                                             psychostimulants==0 ~ 1,
                                           TRUE ~ 0),
         opioids_and_ps_only = case_when(cocaine==0 &
                                           opioids==1 &
                                             psychostimulants==1 ~ 1,
                                           TRUE ~ 0),
         ps_and_cocaine_only = case_when(cocaine==1 &
                                           opioids==0 &
                                             psychostimulants==1 ~ 1,
                                           TRUE ~ 0),
         opioids_ps_and_cocaine = case_when(cocaine==1 &
                                           opioids==1 &
                                             psychostimulants==1 ~ 1,
                                           TRUE ~ 0),
         opioids_without_fentanyl_and_cocaine_only = case_when(cocaine==1 &
                                           opioids_without_fentanyl==1 &
                                             fentanyl==0 &
                                             psychostimulants==0 ~ 1,
                                           TRUE ~ 0),
         opioids_without_fentanyl_and_ps_only = case_when(cocaine==0 &
                                           opioids_without_fentanyl==1 &
                                             fentanyl==0 &
                                             psychostimulants==1 ~ 1,
                                           TRUE ~ 0),
         opioids_without_fentanyl_ps_and_cocaine = case_when(cocaine==1 &
                                           opioids_without_fentanyl==1 &
                                             fentanyl==0 &
                                             psychostimulants==1 ~ 1,
                                           TRUE ~ 0),
         fentanyl_and_cocaine_only = case_when(cocaine==1 &
                                           fentanyl==1 &
                                             opioids_without_fentanyl==0 &
                                             psychostimulants==0 ~ 1,
                                           TRUE ~ 0),
         fentanyl_and_ps_only = case_when(cocaine==0 &
                                           fentanyl==1 &
                                            opioids_without_fentanyl==0 &
                                            psychostimulants==1 ~ 1,
                                           TRUE ~ 0),
         fentanyl_ps_and_cocaine = case_when(cocaine==1 &
                                           fentanyl==1 &
                                            opioids_without_fentanyl==0 &
                                            psychostimulants==1 ~ 1,
                                           TRUE ~ 0)
         )
```


generate summaries by year and save to output file
```{r}
OD_summary_not_mu <- ODs_polysub %>% 
  group_by(year) %>% 
  summarize("Opioid Overdose Deaths" = sum(opioids),
            "Opioid Overdose Deaths without Fentanyl" = sum(opioids_without_fentanyl),
            "Fentanyl Overdose Deaths" = sum(fentanyl),
            "Cocaine Overdose Deaths" = sum(cocaine),
            "Psychostimulant Overdose Deaths" = sum(psychostimulants))

OD_summary_mu <- ODs_polysub %>% 
  group_by(year) %>% 
  summarize("Opioid-only Overdose Deaths" = sum(opioids_only),
            "Opioid-only Overdose Deaths without Fentanyl" = sum(opioids_without_fentanyl_only),
            "Fentanyl-only Overdose Deaths" = sum(fentanyl_only),
            "Cocaine-only Overdose Deaths" = sum(cocaine_only),
            "Psychostimulant-only Overdose Deaths" = sum(psychostimulants_only))

OD_summary_not_mu_alc <- ODs_polysub %>% 
  group_by(year) %>% 
  summarize("Opioid Overdose Deaths with Alcohol" = sum(opioids_w_alc),
            "Opioid Overdose Deaths without Alcohol" = sum(opioids_wo_alc),
            "Opioid Overdose Deaths without Fentanyl with Alcohol" = sum(opioids_without_fentanyl_w_alc),
            "Opioid Overdose Deaths without Fentanyl without Alcohol" = sum(opioids_without_fentanyl_wo_alc),
            "Fentanyl Overdose Deaths with Alcohol" = sum(fentanyl_w_alc),
            "Fentanyl Overdose Deaths without Alcohol" = sum(fentanyl_wo_alc),
            "Cocaine Overdose Deaths with Alcohol" = sum(cocaine_w_alc),
            "Cocaine Overdose Deaths without Alcohol" = sum(cocaine_wo_alc),
            "Psychostimulant Overdose Deaths with Alcohol" = sum(psychostimulants_w_alc),
            "Psychostimulant Overdose Deaths without Alcohol" = sum(psychostimulants_wo_alc))

OD_summary_mu_alc <- ODs_polysub %>% 
  group_by(year) %>% 
  summarize("Opioid-only Overdose Deaths with Alcohol" = sum(opioids_only_w_alc),
            "Opioid-only Overdose Deaths without Alcohol" = sum(opioids_only_wo_alc),
            "Opioid-only Overdose Deaths without Fentanyl with Alcohol" = sum(opioids_without_fentanyl_only_w_alc),
            "Opioid-only Overdose Deaths without Fentanyl without Alcohol" = sum(opioids_without_fentanyl_only_wo_alc),
            "Fentanyl-only Overdose Deaths with Alcohol" = sum(fentanyl_only_w_alc),
            "Fentanyl-only Overdose Deaths without Alcohol" = sum(fentanyl_only_wo_alc),
            "Cocaine-only Overdose Deaths with Alcohol" = sum(cocaine_only_w_alc),
            "Cocaine-only Overdose Deaths without Alcohol" = sum(cocaine_only_wo_alc),
            "Psychostimulant-only Overdose Deaths with Alcohol" = sum(psychostimulants_only_w_alc),
            "Psychostimulant-only Overdose Deaths without Alcohol" = sum(psychostimulants_only_wo_alc))

OD_summary_polysub <- ODs_polysub %>% 
  group_by(year) %>% 
  summarize("Opioid and Cocaine Overdose without Psychostimulants" = sum(opioids_and_cocaine_only),
            "Opioid and Psychostimulant Overdose without Cocaine" = sum(opioids_and_ps_only),
            "Psychostimulant and Cocaine Overdose without Opioids" = sum(ps_and_cocaine_only),
            "Opioid, Psychostimulant, and Cocaine Overdoses" = sum(opioids_ps_and_cocaine),
            "Opioid and Cocaine Overdose without Fentanyl or Psychostimulants" = sum(opioids_without_fentanyl_and_cocaine_only),
            "Opioid and Psychostimulant Overdose without Fentanyl or Cocaine" = sum(opioids_without_fentanyl_and_ps_only),
            "Opioid, Psychostimulant, and Cocaine Overdose without Fentanyl" = sum(opioids_without_fentanyl_ps_and_cocaine),
            "Fentanyl and Cocaine Overdose without other opioids or Psychostimulants" = sum(fentanyl_and_cocaine_only),
            "Fentanyl and Psychositimulant Overdose without other opioids or Cocaine" = sum(fentanyl_and_ps_only),
            "Fentanyl, Psychostimulant, and Cocaine Overdose without other opioids" = sum(fentanyl_ps_and_cocaine))

all_summaries <- cbind(OD_summary_not_mu, 
                       OD_summary_mu[,-1], 
                       OD_summary_not_mu_alc[,-1], 
                       OD_summary_mu_alc[,-1],
                       OD_summary_polysub[,-1])
write.csv(all_summaries, "OD_category_summaries.csv")
  
```


