---
title: "analyze ODs"
author: "Catherine DiGennaro"
date: "5/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

import OD data
```{r}
all_ODs <- read.csv("NCHS_all_ODs.csv") 
```

concatenate ICD columns
```{r}
all_ODs <- all_ODs %>% 
  unite(all_codes, record_1:record_20, sep = "|", remove=TRUE)
```

assign specific drug category codes 
```{r}
# opioids <- "T400|T401|T402|T403|T404|T406"
# opioids_without_fentanyl <- "T400|T401|T402|T403|T406"
heroin <- "T401"
rx_opioids <- "T400|T402|T403|T406"
fentanyl <- "T404"
cocaine <- "T405"
psychostimulants <- "T436"
# alcohol <- "E244|F10|G312|G621|G721|I426|K292|K70|K852|K860|R780|X45|X65|Y15"
```

classify each overdose by type of drug present
```{r}
ODs_classified <- all_ODs %>%
  mutate(
    heroin = case_when(grepl(heroin, all_codes) ~ 1,
                       TRUE ~ 0),
    rx_opioids = case_when(grepl(rx_opioids, all_codes) ~ 1,
                           TRUE ~ 0),
    fentanyl = case_when(grepl(fentanyl, all_codes) ~ 1,
                         TRUE ~ 0),
    cocaine = case_when(grepl(cocaine, all_codes) ~ 1,
                        TRUE ~ 0),
    psychostimulants = case_when(grepl(psychostimulants, all_codes) ~ 1,
                                 TRUE ~ 0)
    # ,alcohol = case_when(grepl(alcohol, all_codes) ~ 1,
    #                      TRUE ~ 0))
  )

```

skip for FDA grant;
classify each drug overdose by whether alcohol was present
```{r}
ODs_alcohol <- ODs_classified %>% 
  mutate(opioids_w_alc = case_when(opioids==1 &
                                     alcohol==1 ~ 1,
                                   TRUE ~ 0),
         opioids_wo_alc = case_when(opioids==1 &
                                     alcohol==0 ~ 1,
                                   TRUE ~ 0),
         opioids_without_fentanyl_w_alc = case_when(opioids_without_fentanyl==1 &
                                     alcohol==1 ~ 1,
                                   TRUE ~ 0),
         opioids_without_fentanyl_wo_alc = case_when(opioids_without_fentanyl==1 &
                                     alcohol==0 ~ 1,
                                   TRUE ~ 0),
         fentanyl_w_alc = case_when(fentanyl==1 &
                                     alcohol==1 ~ 1,
                                   TRUE ~ 0),
         fentanyl_wo_alc = case_when(fentanyl==1 &
                                     alcohol==0 ~ 1,
                                   TRUE ~ 0),
         cocaine_w_alc = case_when(cocaine==1 &
                                     alcohol==1 ~ 1,
                                   TRUE ~ 0),
         cocaine_wo_alc = case_when(cocaine==1 &
                                     alcohol==0 ~ 1,
                                   TRUE ~ 0),
         psychostimulants_w_alc = case_when(psychostimulants==1 &
                                     alcohol==1 ~ 1,
                                   TRUE ~ 0),
         psychostimulants_wo_alc = case_when(psychostimulants==1 &
                                     alcohol==0 ~ 1,
                                   TRUE ~ 0))
```


assign mutually exclusive labels to drug overdoses
```{r}
ODs_mut_excl <- ODs_classified %>%
  mutate(
    heroin_only = case_when(
      heroin == 1 &
        rx_opioids == 0 &
        fentanyl == 0 &
        cocaine == 0 &
        psychostimulants == 0 ~ 1,
      TRUE ~ 0
    ),
    rx_opioids_only = case_when(
      heroin == 0 &
        rx_opioids == 1 &
        fentanyl == 0 &
        cocaine == 0 &
        psychostimulants == 0 ~ 1,
      TRUE ~ 0
    ),
    fentanyl_only = case_when(
      heroin == 0 &
        rx_opioids == 0 &
        fentanyl == 1 &
        cocaine == 0 &
        psychostimulants == 0 ~ 1,
      TRUE ~ 0
    ),
    cocaine_only = case_when(
      heroin == 0 &
        rx_opioids == 0 &
        fentanyl == 0 &
        cocaine == 1 &
        psychostimulants == 0 ~ 1,
      TRUE ~ 0
    ),
    psychostimulants_only = case_when(
      heroin == 0 &
        rx_opioids == 0 &
        fentanyl == 0 &
        cocaine == 0 &
        psychostimulants == 1 ~ 1,
      TRUE ~ 0
    ) #,
         # opioids_only_w_alc = case_when(opioids==1 & 
         #                                  cocaine==0 & 
         #                                  psychostimulants==0 &
         #                                  alcohol==1 ~ 1,
         #                          TRUE ~ 0),
         # opioids_without_fentanyl_only_w_alc = case_when(opioids_without_fentanyl==1 &
         #                                             fentanyl==0 &
         #                                             cocaine==0 &
         #                                             psychostimulants==0 &
         #                                             alcohol==1 ~ 1,
         #                                           TRUE ~ 0),
         # fentanyl_only_w_alc = case_when(fentanyl==1 & 
         #                             cocaine==0 &
         #                             psychostimulants==0 & 
         #                             opioids_without_fentanyl==0 &
         #                             alcohol==1 ~ 1, 
         #                           TRUE ~ 0),
         # cocaine_only_w_alc = case_when(cocaine==1 &
         #                            opioids==0 &
         #                            psychostimulants==0 &
         #                              alcohol==1 ~ 1,
         #                          TRUE ~ 0),
         # psychostimulants_only_w_alc = case_when(psychostimulants==1 &
         #                                     cocaine==0 &
         #                                     opioids==0 &
         #                                       alcohol==1 ~ 1,
         #                                   TRUE ~ 0),
         # opioids_only_wo_alc = case_when(opioids==1 & 
         #                                  cocaine==0 & 
         #                                  psychostimulants==0 &
         #                                  alcohol==0 ~ 1,
         #                          TRUE ~ 0),
         # opioids_without_fentanyl_only_wo_alc = case_when(opioids_without_fentanyl==1 &
         #                                             fentanyl==0 &
         #                                             cocaine==0 &
         #                                             psychostimulants==0 &
         #                                             alcohol==0 ~ 1,
         #                                           TRUE ~ 0),
         # fentanyl_only_wo_alc = case_when(fentanyl==1 & 
         #                             cocaine==0 &
         #                             psychostimulants==0 & 
         #                             opioids_without_fentanyl==0 &
         #                             alcohol==0 ~ 1, 
         #                           TRUE ~ 0),
         # cocaine_only_wo_alc = case_when(cocaine==1 &
         #                            opioids==0 &
         #                            psychostimulants==0 &
         #                              alcohol==0 ~ 1,
         #                          TRUE ~ 0),
         # psychostimulants_only_wo_alc = case_when(psychostimulants==1 &
         #                                     cocaine==0 &
         #                                     opioids==0 &
         #                                       alcohol==0 ~ 1,
         #                                   TRUE ~ 0)
         )
```

assign polysubstance drug overdoses by combos of drugs present
```{r}
ODs_polysub <- ODs_mut_excl %>%
  mutate(
    heroin_with_or_without_rx = case_when(
      heroin == 1 &
        fentanyl == 0 &
        cocaine == 0 &
        psychostimulants == 0 ~ 1,
      TRUE ~ 0
    ),
    PS_and_synthetics_with_or_without_opioids_no_coc = case_when(
      psychostimulants == 1 &
        fentanyl == 1 &
        cocaine == 0 ~ 1,
      TRUE ~ 0
    ),
    coc_and_synthetics_with_or_without_opioids_no_PS = case_when(
      psychostimulants == 0 &
        fentanyl == 1 &
        cocaine == 1 ~ 1,
      TRUE ~ 0
    ),
    coc_with_heroin_or_rx = case_when(
      cocaine == 1 &
        (heroin == 1 |
        rx_opioids == 1) &
        fentanyl == 0 &
        psychostimulants == 0 ~ 1,
      TRUE ~ 0
    ),
    ps_with_heroin_or_rx = case_when(
      cocaine == 0 &
        (heroin == 1 |
        rx_opioids == 1) &
        fentanyl == 0 &
        psychostimulants == 1 ~ 1,
      TRUE ~ 0
    ),
    synthetics_without_PS_or_coc_with_or_without_other_opioids = case_when(
      fentanyl == 1 &
        psychostimulants == 0 &
        cocaine == 0 ~ 1,
      TRUE ~ 0
    ),
    PS_coc_with_or_without_opioids = case_when(
      psychostimulants == 1 &
        cocaine == 1 ~ 1,
      TRUE ~ 0
    ),
    # PS_coc_synthetics_with_or_without_rx_and_heroin = case_when(
    #   psychostimulants == 1 &
    #     cocaine == 1 &
    #     fentanyl == 1  ~ 1,
    #   TRUE ~ 0
    # ),
    # PS_coc_only = case_when(
    #   psychostimulants == 1 &
    #     cocaine == 1 &
    #     fentanyl == 0 &
    #     rx_opioids == 0 &
    #     heroin == 0 ~ 1,
    #   TRUE ~ 0
    # ),
    all_other_combos = case_when(
      rx_opioids_only == 0 &
        heroin_with_or_without_rx == 0 &
        cocaine_only == 0 &
        psychostimulants_only == 0 &
        PS_and_synthetics_with_or_without_opioids_no_coc == 0 &
        coc_and_synthetics_with_or_without_opioids_no_PS == 0 &
        coc_with_heroin_or_rx == 0 &
        ps_with_heroin_or_rx == 0 &
        synthetics_without_PS_or_coc_with_or_without_other_opioids == 0 &
        PS_coc_with_or_without_opioids == 0 ~ 1,
      TRUE ~ 0
    ),
    ps_or_coc_NOT_MUTEXCL = case_when(
      (psychostimulants == 1 |
        cocaine == 1 ~ 1),
      TRUE ~ 0
    )
    
    #,
    # ps_and_cocaine_only = case_when(cocaine == 1 &
    #                                   opioids == 0 &
    #                                   psychostimulants == 1 ~ 1,
    #                                 TRUE ~ 0),
    # opioids_ps_and_cocaine = case_when(cocaine == 1 &
    #                                      opioids == 1 &
    #                                      psychostimulants == 1 ~ 1,
    #                                    TRUE ~ 0),
    # opioids_without_fentanyl_and_cocaine_only = case_when(
    #   cocaine == 1 &
    #     opioids_without_fentanyl == 1 &
    #     fentanyl == 0 &
    #     psychostimulants == 0 ~ 1,
    #   TRUE ~ 0
    # ),
    # opioids_without_fentanyl_and_ps_only = case_when(
    #   cocaine == 0 &
    #     opioids_without_fentanyl == 1 &
    #     fentanyl == 0 &
    #     psychostimulants == 1 ~ 1,
    #   TRUE ~ 0
    # ),
    # opioids_without_fentanyl_ps_and_cocaine = case_when(
    #   cocaine == 1 &
    #     opioids_without_fentanyl == 1 &
    #     fentanyl == 0 &
    #     psychostimulants == 1 ~ 1,
    #   TRUE ~ 0
    # ),
    # fentanyl_and_cocaine_only = case_when(
    #   cocaine == 1 &
    #     fentanyl == 1 &
    #     opioids_without_fentanyl ==
    #     0 &
    #     psychostimulants == 0 ~ 1,
    #   TRUE ~ 0
    # ),
    # fentanyl_and_ps_only = case_when(
    #   cocaine == 0 &
    #     fentanyl == 1 &
    #     opioids_without_fentanyl == 0 &
    #     psychostimulants == 1 ~ 1,
    #   TRUE ~ 0
    # ),
    # fentanyl_ps_and_cocaine = case_when(
    #   cocaine == 1 &
    #     fentanyl == 1 &
    #     opioids_without_fentanyl == 0 &
    #     psychostimulants == 1 ~ 1,
    #   TRUE ~ 0
    # )
  )
```


generate summaries by year and save to output file
```{r}
OD_summary_not_mu <- ODs_polysub %>% 
  group_by(year) %>% 
  summarize("Opioid Overdose Deaths" = sum(opioids),
            "Opioid Overdose Deaths without Fentanyl" = sum(opioids_without_fentanyl),
            "Fentanyl Overdose Deaths" = sum(fentanyl),
            "Cocaine Overdose Deaths" = sum(cocaine),
            "Psychostimulant Overdose Deaths" = sum(psychostimulants))

OD_summary_mu <- ODs_polysub %>% 
  group_by(year) %>% 
  summarize("Opioid-only Overdose Deaths" = sum(opioids_only),
            "Opioid-only Overdose Deaths without Fentanyl" = sum(opioids_without_fentanyl_only),
            "Fentanyl-only Overdose Deaths" = sum(fentanyl_only),
            "Cocaine-only Overdose Deaths" = sum(cocaine_only),
            "Psychostimulant-only Overdose Deaths" = sum(psychostimulants_only))

OD_summary_not_mu_alc <- ODs_polysub %>% 
  group_by(year) %>% 
  summarize("Opioid Overdose Deaths with Alcohol" = sum(opioids_w_alc),
            "Opioid Overdose Deaths without Alcohol" = sum(opioids_wo_alc),
            "Opioid Overdose Deaths without Fentanyl with Alcohol" = sum(opioids_without_fentanyl_w_alc),
            "Opioid Overdose Deaths without Fentanyl without Alcohol" = sum(opioids_without_fentanyl_wo_alc),
            "Fentanyl Overdose Deaths with Alcohol" = sum(fentanyl_w_alc),
            "Fentanyl Overdose Deaths without Alcohol" = sum(fentanyl_wo_alc),
            "Cocaine Overdose Deaths with Alcohol" = sum(cocaine_w_alc),
            "Cocaine Overdose Deaths without Alcohol" = sum(cocaine_wo_alc),
            "Psychostimulant Overdose Deaths with Alcohol" = sum(psychostimulants_w_alc),
            "Psychostimulant Overdose Deaths without Alcohol" = sum(psychostimulants_wo_alc))

OD_summary_mu_alc <- ODs_polysub %>% 
  group_by(year) %>% 
  summarize("Opioid-only Overdose Deaths with Alcohol" = sum(opioids_only_w_alc),
            "Opioid-only Overdose Deaths without Alcohol" = sum(opioids_only_wo_alc),
            "Opioid-only Overdose Deaths without Fentanyl with Alcohol" = sum(opioids_without_fentanyl_only_w_alc),
            "Opioid-only Overdose Deaths without Fentanyl without Alcohol" = sum(opioids_without_fentanyl_only_wo_alc),
            "Fentanyl-only Overdose Deaths with Alcohol" = sum(fentanyl_only_w_alc),
            "Fentanyl-only Overdose Deaths without Alcohol" = sum(fentanyl_only_wo_alc),
            "Cocaine-only Overdose Deaths with Alcohol" = sum(cocaine_only_w_alc),
            "Cocaine-only Overdose Deaths without Alcohol" = sum(cocaine_only_wo_alc),
            "Psychostimulant-only Overdose Deaths with Alcohol" = sum(psychostimulants_only_w_alc),
            "Psychostimulant-only Overdose Deaths without Alcohol" = sum(psychostimulants_only_wo_alc))

OD_summary_polysub <- ODs_polysub %>% 
  group_by(year) %>% 
  summarize("Opioid and Cocaine Overdose without Psychostimulants" = sum(opioids_and_cocaine_only),
            "Opioid and Psychostimulant Overdose without Cocaine" = sum(opioids_and_ps_only),
            "Psychostimulant and Cocaine Overdose without Opioids" = sum(ps_and_cocaine_only),
            "Opioid Overdose with Cocaine OR Psychostimulants" = sum(opioids_and_ps_or_cocaine),
            "Opioid, Psychostimulant, and Cocaine Overdoses" = sum(opioids_ps_and_cocaine),
            "Opioid and Cocaine Overdose without Fentanyl or Psychostimulants" = sum(opioids_without_fentanyl_and_cocaine_only),
            "Opioid and Psychostimulant Overdose without Fentanyl or Cocaine" = sum(opioids_without_fentanyl_and_ps_only),
            "Opioid, Psychostimulant, and Cocaine Overdose without Fentanyl" = sum(opioids_without_fentanyl_ps_and_cocaine),
            "Fentanyl and Cocaine Overdose without other opioids or Psychostimulants" = sum(fentanyl_and_cocaine_only),
            "Fentanyl and Psychositimulant Overdose without other opioids or Cocaine" = sum(fentanyl_and_ps_only),
            "Fentanyl, Psychostimulant, and Cocaine Overdose without other opioids" = sum(fentanyl_ps_and_cocaine))

all_summaries <- cbind(OD_summary_not_mu, 
                       OD_summary_mu[,-1], 
                       OD_summary_not_mu_alc[,-1], 
                       OD_summary_mu_alc[,-1],
                       OD_summary_polysub[,-1])
#write.csv(all_summaries, "OD_category_summaries.csv")
```

summary needed for FDA grant
```{r}
grant_summary <- ODs_polysub %>%
  group_by(year) %>%
  summarize(
    "Rx opioids only" = sum(rx_opioids_only),
    "Heroin with or without Rx opioids" = sum(heroin_with_or_without_rx),
    "Cocaine only" = sum(cocaine_only),
    "Psychostimulants only" = sum(psychostimulants_only),
    "Psychostimulants and synthetics with or without other opioids" = sum(PS_and_synthetics_with_or_without_opioids_no_coc),
    "Cocaine and synthetics with or without other opioids" = sum(coc_and_synthetics_with_or_without_opioids_no_PS),
    "Cocaine with heroin and/or Rx opioids" = sum(coc_with_heroin_or_rx),
    "Psychostimulants with heroin and/or Rx opioids" = sum(ps_with_heroin_or_rx),
    "Synthetics with or without other opioids" = sum(synthetics_without_PS_or_coc_with_or_without_other_opioids),
    "Psychostimulants and cocaine with or without opioids" = sum(PS_coc_with_or_without_opioids),
    "All other drug combinations" = sum(all_other_combos)
  )

#write.csv(grant_summary, "grant_summary_ODs.csv")

```


supplementary quick analyses ---

PS quick summary - how many psychostimulant-involved ODs are psychostimulant-only?
```{r}
ODs_psychostimulants <- ODs_polysub %>%
  mutate(any_PS = case_when(psychostimulants == 1 ~ 1,
                            TRUE ~ 0))

PS_summary <- ODs_psychostimulants %>% 
  group_by(year) %>% 
  summarize(
    "All psychostimulant-involved overdoses" = sum(any_PS),
    "Psychostimulant-only overdoses" = sum(psychostimulants_only),
    "Prop psychostimulant-only ODs out of all psychostimulant ODs" = sum(psychostimulants_only)/sum(any_PS)
  )

ps_p <- PS_summary %>% 
  ggplot(aes(x=year, y=`Prop psychostimulant-only ODs out of all psychostimulant ODs`)) + 
  geom_line(color='blue') + 
  coord_cartesian(ylim = c(0, .7)) +
  theme_bw()

ps_p
```

all possible combinations
```{r}
drugs <- c("rx_opioids", "heroin", "fentanyl", "psychostimulants", "cocaine")
two <- data.frame(combn(drugs, 2))
three <- data.frame(combn(drugs, 3))
four <- data.frame(combn(drugs, 4))

# write.csv(two, "two.csv")
# write.csv(three, "three.csv")
# write.csv(four, "four.csv")
```

summary of cocaine or PS, not mutually exclusive
```{r}
ps_or_coc <- ODs_polysub %>% 
  group_by(year) %>% 
  summarize("Psychostimulant- or Cocaine-involved Overdoses" = sum(ps_or_coc_NOT_MUTEXCL))

write.csv(ps_or_coc, "PS_or_Cocaine_ODs.csv")

ps_OR_coc_p <- ps_or_coc %>% 
  ggplot(aes(x = year, y = `Psychostimulant- or Cocaine-involved Overdoses`)) + 
  geom_line() + 
  theme_bw()
```



